;(function() {
"use strict";

void 0===window.blueprintUE&&(window.blueprintUE={}),void 0===window.blueprintUE.diff&&(window.blueprintUE.diff={});
function createElem(e,t,l){for(var n=document.createElement(e),r=0,a=t.length;r<a;++r)""!==t[r]&&n.classList.add(t[r]);for(r=0,a=l.length;r<a;++r)n.setAttribute(l[r].name,l[r].value);return n}function createElems(e){for(var t,l,n=[],r=0,a=e.length,c=0,o=null;r<a;++r)if((o=null)!==e[r]){if(void 0!==e[r].tag&&(o=createElem(e[r].tag,e[r].classes||[],e[r].attrs||[]),void 0!==e[r].childs))for(c=0,l=(t=createElems(e[r].childs)).length;c<l;++c)o.appendChild(t[c]);void 0!==e[r].text&&""!==e[r].text&&(null===o?o=document.createTextNode(e[r].text):o.textContent=e[r].text),null!==o&&n.push(o)}return n}
function Application(t,e,n,r){var i,s;return"string"!=typeof t?new TypeError("Argument 'textPrevious', expect string, get "+typeof t):"string"!=typeof e?new TypeError("Argument 'textCurrent', expect string, get "+typeof e):n instanceof HTMLElement?(i=new Environment(n,r))instanceof Environment?(s=new Interactor(n))instanceof Interactor?(this.data={textPrevious:t,textCurrent:e,htmlElement:n,options:r||{}},this.instances={environment:i,interactor:s},this.renderers={previous:null,current:null},this.callbackInitialization=null,this.error=null,void(this.callbackCounter=2)):s:i:new TypeError("Argument 'htmlElement', expect HTMLElement, get "+typeof n)}Application.prototype.start=function(t){var e=this.callbackRenderer.bind(this);this.callbackCounter=2,"function"==typeof t&&(this.callbackInitialization=t),this.instances.environment.start(),t=this.instances.environment.getDomRenderers(),this.renderers.previous=new window.blueprintUE.render.Main(this.data.textPrevious,t.previous,this.data.options),this.renderers.current=new window.blueprintUE.render.Main(this.data.textCurrent,t.current,this.data.options),this.renderers.previous.start(e),this.renderers.current.start(e)},Application.prototype.callbackRenderer=function(t,e){--this.callbackCounter,t||(this.error=e),0<this.callbackCounter||(this.instances.interactor.start(this.renderers.previous,this.renderers.current),this.computeDiff(),null!==this.callbackInitialization&&(this.callbackInitialization(t,this.error),this.callbackInitialization=null))},Application.prototype.computeDiff=function(){var t=new Diff;t.compute(this.renderers.previous.getBlueprintData(),this.renderers.current.getBlueprintData()),this.instances.environment.resetSummary(),this.instances.environment.addSummaryItems(t.getSummaryItems())},Application.prototype.stop=function(){this.renderers.previous.stop(),this.renderers.current.stop(),this.instances.interactor.stop(),this.instances.environment.stop(),this.instances.interactor=null,this.instances.environment=null,this.data.textPrevious="",this.data.textCurrent="",this.data.htmlElement=null,this.data.options={},this.renderers.previous=null,this.renderers.current=null},Application.prototype.updateBlueprintTextPrevious=function(t,e){this.renderers.previous.updateBlueprintText(t,e),this.computeDiff()},Application.prototype.updateBlueprintTextCurrent=function(t,e){this.renderers.current.updateBlueprintText(t,e),this.computeDiff()};
function Diff(){this.summary=[]}Diff.prototype.compute=function(e,d){var o=0,i=0,t=e.nodesParsed.length,n=d.nodesParsed.length,s={},a={};for(this.summary=[];o<t;++o)s[e.nodesParsed[o].node.guid]=o;for(;i<n;++i)a[d.nodesParsed[i].node.guid]=i;for(i=0;i<n;++i)void 0===s[d.nodesParsed[i].node.guid]?this.addSummaryItem("added-node","Added Node '"+d.nodesParsed[i].node.generateHTMLHeader().childs[1].text+"'",d.nodesParsed[i].node.position,d.nodesParsed[i].node.deltaPosition):this.checkNodeUpdates(e.nodesParsed[s[d.nodesParsed[i].node.guid]].node,d.nodesParsed[i].node);for(o=0;o<t;++o)void 0===a[e.nodesParsed[o].node.guid]&&this.addSummaryItem("removed-node","Removed Node '"+e.nodesParsed[o].node.generateHTMLHeader().childs[1].text+"'",e.nodesParsed[o].node.position,e.nodesParsed[o].node.deltaPosition)},Diff.prototype.checkNodeUpdates=function(e,d){var o=0,i=0,t={},n={};for(e.comment!==d.comment&&this.addSummaryItem("modified-comment","Comment Modified Node '"+d.generateHTMLHeader().childs[1].text+"'",d.position,d.deltaPosition),e.position[0]===d.position[0]&&e.position[1]===d.position[1]||this.addSummaryItem("moved-node","Moved Node '"+d.generateHTMLHeader().childs[1].text+"'",d.position,d.deltaPosition),o=0,i=e.pins.length;o<i;++o)t[e.pins[o].id]=o;for(o=0,i=d.pins.length;o<i;++o)n[d.pins[o].id]=o;for(o=0,i=d.pins.length;o<i;++o)void 0===t[d.pins[o].id]?this.addSummaryItem("added-pin","Added Pin ''",d.position,d.deltaPosition):this.checkPinUpdates(e.pins[t[d.pins[o].id]],d.pins[o],d);for(o=0,i=e.pins.length;o<i;++o)void 0===n[e.pins[o].id]&&this.addSummaryItem("removed-pin","Removed Pin ''",e.position,e.deltaPosition)},Diff.prototype.checkPinUpdates=function(e,d,o){for(var i=0,t=0,n=e.getLinks(),s=d.getLinks(),a={},r={},i=0,t=n.length;i<t;++i)a[n[i]]=i;for(i=0,t=n.length;i<t;++i)r[s[i]]=i;for(i=0,t=s.length;i<t;++i)void 0===a[s[i]]&&this.addSummaryItem("added-link","Added Link to '"+e.findText()+"'",o.position,o.deltaPosition);for(i=0,t=n.length;i<t;++i)void 0===r[n[i]]&&this.addSummaryItem("removed-link","Removed Link to '"+e.findText()+"'",o.position,o.deltaPosition);e.getValue()!==d.getValue()&&this.addSummaryItem("removed-pin","Pin Default '"+e.findText()+"' '"+e.getValue()+"' -> '"+d.getValue()+"'",o.position,o.deltaPosition)},Diff.prototype.addSummaryItem=function(e,d,o,i){this.summary.push({type:e,text:d,nodePosition:o,nodeDeltaPosition:i})},Diff.prototype.getSummaryItems=function(){return this.summary};
function Environment(t,e){if(!(t instanceof HTMLElement))return new TypeError("Argument 'htmlElement', expect HTMLElement, get "+typeof t);this.data={htmlElement:t,options:e||{}},this.dom={root:t,rendererPrevious:null,rendererCurrent:null,summaryList:null}}Environment.prototype.start=function(){var t=[];this.data.options.height&&t.push("height:"+this.data.options.height),t=createElems([{tag:"div",classes:["bue-diff"],attrs:[{name:"style",value:t.join(";")}],childs:[{tag:"div",classes:["summary"],childs:[{tag:"div",classes:["summary__buttons"],childs:[{tag:"button",classes:["summary__button"],attrs:[{name:"data-btn",value:"lock"}],childs:[{tag:"div",classes:["icon","lock"]},{tag:"br"},{text:"Lock / Unlock"}]},{tag:"button",classes:["summary__button"],attrs:[{name:"data-btn",value:"layout"}],text:"Vertical / Horizontal"}]},{tag:"div",classes:["summary__title"],text:"Summary"},{tag:"ul",classes:["summary__list"]}]},{tag:"div",classes:["renderers"],childs:[{tag:"div",classes:["renderer","previous"],attrs:[{name:"data-renderer",value:"previous"}]},{tag:"div",classes:["handler"]},{tag:"div",classes:["renderer","current"],attrs:[{name:"data-renderer",value:"current"}]}]}]}]),this.dom.root.appendChild(t[0]),this.dom.rendererPrevious=this.dom.root.querySelector("[data-renderer=previous]"),this.dom.rendererCurrent=this.dom.root.querySelector("[data-renderer=current]"),this.dom.summaryList=this.dom.root.querySelector(".summary__list")},Environment.prototype.getDomRenderers=function(){return{previous:this.dom.rendererPrevious,current:this.dom.rendererCurrent}},Environment.prototype.resetSummary=function(){for(var t=this.dom.summaryList.lastElementChild;t;)this.dom.summaryList.removeChild(t),t=this.dom.summaryList.lastElementChild},Environment.prototype.addSummaryItems=function(t){for(var e,r=document.createDocumentFragment(),s=0,o=t.length;s<o;s++)e=this.generateSummaryItem(t[s]),r.appendChild(createElems(e)[0]);this.dom.summaryList.appendChild(r)},Environment.prototype.generateSummaryItem=function(t){return[{tag:"li",classes:["summary__list-item","summary__list-item--"+t.type],attrs:[{name:"data-position-x",value:(t.nodePosition[0]+t.nodeDeltaPosition[0]-50).toString()},{name:"data-position-y",value:(t.nodePosition[1]+t.nodeDeltaPosition[1]-150).toString()}],text:t.text}]},Environment.prototype.stop=function(){for(var t=this.dom.root.lastElementChild;t;)this.dom.root.removeChild(t),t=this.dom.root.lastElementChild;this.dom.root=null,this.dom.rendererPrevious=null,this.dom.rendererCurrent=null,this.dom.summaryList=null,this.data.htmlElement=null,this.data.options={}};
function Interactor(e){if(!(e instanceof HTMLElement))return new TypeError("Argument 'htmlElement', expect HTMLElement, get "+typeof e);this.dom={root:e,diffRoot:null,rendererPrevious:null,rendererCurrent:null,renderersWrapper:null,handler:null,summary:null,btnLock:null,btnLayout:null,canvasPrevious:null,canvasCurrent:null,framePrevious:null,frameCurrent:null},this.rendererPrevious=null,this.rendererCurrent=null,this.isSynced=!0,this.layout="H",this.isHandlerDragging=!1,this.observer=null,this.eventsBinding={mouseDown:this.eventMouseDown.bind(this),mouseMove:this.eventMouseMove.bind(this),mouseUp:this.eventMouseUp.bind(this),clickSummaryItem:this.eventClickSummaryItem.bind(this),clickButtonLock:this.eventClickButtonLock.bind(this),clickButtonLayout:this.eventClickButtonLayout.bind(this),mutationObserver:this.eventMutationObserver.bind(this)}}Interactor.prototype.start=function(e,t){this.rendererPrevious=e,this.rendererCurrent=t,this.dom.diffRoot=this.dom.root.querySelector(".bue-diff"),this.dom.rendererPrevious=this.dom.root.querySelector("[data-renderer=previous]"),this.dom.rendererCurrent=this.dom.root.querySelector("[data-renderer=current]"),this.dom.renderersWrapper=this.dom.root.querySelector(".renderers"),this.dom.handler=this.dom.root.querySelector(".handler"),this.dom.summary=this.dom.root.querySelector(".summary"),this.dom.btnLock=this.dom.root.querySelector(".summary__button[data-btn='lock']"),this.dom.btnLayout=this.dom.root.querySelector(".summary__button[data-btn='layout']"),this.dom.canvasPrevious=this.dom.rendererPrevious.querySelector(".canvas"),this.dom.canvasCurrent=this.dom.rendererCurrent.querySelector(".canvas"),this.dom.framePrevious=this.dom.rendererPrevious.querySelector(".frame"),this.dom.frameCurrent=this.dom.rendererCurrent.querySelector(".frame"),document.addEventListener("mousedown",this.eventsBinding.mouseDown),document.addEventListener("mousemove",this.eventsBinding.mouseMove),document.addEventListener("mouseup",this.eventsBinding.mouseUp),this.dom.summary.addEventListener("click",this.eventsBinding.clickSummaryItem),this.dom.btnLock.addEventListener("click",this.eventsBinding.clickButtonLock),this.dom.btnLayout.addEventListener("click",this.eventsBinding.clickButtonLayout),this.copyPanning()},Interactor.prototype.eventMouseDown=function(e){e.target===this.dom.handler&&(this.isHandlerDragging=!0)},Interactor.prototype.eventMouseMove=function(e){var t=e.clientX-this.dom.renderersWrapper.offsetLeft,e=e.clientY-this.dom.renderersWrapper.offsetTop,r=this.dom.diffRoot.getBoundingClientRect().height;if(!this.isHandlerDragging)return!1;"H"===this.layout?(this.dom.rendererPrevious.style.width=Math.max(60,t-8)+"px",this.dom.rendererPrevious.style.flexGrow="0"):"V"!==this.layout||r-150<e||e<150||(this.dom.framePrevious.style.height=e+"px",this.dom.frameCurrent.style.height=r-e-20+"px")},Interactor.prototype.eventMouseUp=function(){this.isHandlerDragging=!1},Interactor.prototype.eventClickSummaryItem=function(e){var t;e.target.classList.contains("summary__list-item")&&(t=e.target.getAttribute("data-position-x")>>0,e=e.target.getAttribute("data-position-y")>>0,this.rendererPrevious.moveTo(-t,-e),this.rendererCurrent.moveTo(-t,-e))},Interactor.prototype.eventClickButtonLock=function(){var e="",t="",r=this.dom.canvasPrevious.style.left.replace("px","")>>0,o=this.dom.canvasPrevious.style.top.replace("px","")>>0,t=this.isSynced?(e="lock","unlock"):(this.rendererCurrent.moveTo(r,o),e="unlock","lock");this.dom.btnLock.querySelector(".icon").classList.remove(e),this.dom.btnLock.querySelector(".icon").classList.add(t),this.isSynced=!this.isSynced},Interactor.prototype.eventClickButtonLayout=function(){var e=this.dom.diffRoot.getBoundingClientRect().height,t=0,r="",o="",n="";"H"===this.layout?(r="V",t=e/2,t-=10,o="column",n="block",this.dom.handler.classList.add("v"),this.dom.rendererPrevious.setAttribute("style","")):(r="H",t=e,o="row",n="flex",this.dom.handler.classList.remove("v")),this.dom.renderersWrapper.style.flexDirection=o,this.dom.renderersWrapper.style.display=n,this.dom.framePrevious.style.height=t+"px",this.dom.frameCurrent.style.height=t+"px",this.layout=r},Interactor.prototype.eventMutationObserver=function(e){var t,r,o,n,i,s=0,u=e.length;if(!1!==this.isSynced)for(;s<u;++s)if("attributes"===e[s].type){if(t=this.dom.canvasPrevious.getAttribute("style"),r=this.dom.canvasCurrent.getAttribute("style"),(o=e[s].target.getAttribute("style"))===t&&o===r)return;n=e[s].target.style.left.replace("px","")>>0,i=e[s].target.style.top.replace("px","")>>0,o!==t?(this.dom.canvasPrevious.setAttribute("style",o),this.rendererPrevious.moveTo(n,i)):o!==r&&(this.dom.canvasCurrent.setAttribute("style",o),this.rendererCurrent.moveTo(n,i))}},Interactor.prototype.copyPanning=function(){var e={attributes:!0,childList:!1,subtree:!1};this.observer=new MutationObserver(this.eventsBinding.mutationObserver),this.observer.observe(this.dom.canvasPrevious,e),this.observer.observe(this.dom.canvasCurrent,e)},Interactor.prototype.stop=function(){document.removeEventListener("mousedown",this.eventsBinding.mouseDown),document.removeEventListener("mousemove",this.eventsBinding.mouseMove),document.removeEventListener("mouseup",this.eventsBinding.mouseUp),this.dom.summary.removeEventListener("click",this.eventsBinding.clickSummaryItem),this.dom.btnLock.removeEventListener("click",this.eventsBinding.clickButtonLock),this.dom.btnLayout.removeEventListener("click",this.eventsBinding.clickButtonLayout),this.observer.disconnect(),this.dom.root=null,this.dom.diffRoot=null,this.dom.rendererPrevious=null,this.dom.rendererCurrent=null,this.dom.renderersWrapper=null,this.dom.handler=null,this.dom.summary=null,this.dom.btnLock=null,this.dom.btnLayout=null,this.dom.canvasPrevious=null,this.dom.canvasCurrent=null,this.dom.framePrevious=null,this.dom.frameCurrent=null,this.rendererCurrent=null,this.rendererPrevious=null};
function Main(t,e,n,r){var i={},p=null;return"string"!=typeof t?new TypeError("Argument 'textPrevious', expect string, get "+typeof t):"string"!=typeof e?new TypeError("Argument 'textCurrent', expect string, get "+typeof e):n instanceof HTMLElement?(i={textPrevious:t,textCurrent:e,htmlElement:n,options:r||{}},this.start=function(t){p&&(p.stop(),p=null),(p=new Application(i.textPrevious,i.textCurrent,i.htmlElement,i.options)).start(t)},this.updateBlueprintTextPrevious=function(t,e){if("string"!=typeof t)return new TypeError("Argument 'newBlueprintText', expect string, get "+typeof t);i.textPrevious=t,p&&p.updateBlueprintTextPrevious(t,e)},this.updateBlueprintTextCurrent=function(t,e){if("string"!=typeof t)return new TypeError("Argument 'newBlueprintText', expect string, get "+typeof t);i.textCurrent=t,p&&p.updateBlueprintTextCurrent(t,e)},void(this.stop=function(){p&&(p.stop(),p=null)})):new TypeError("Argument 'htmlElement', expect HTMLElement, get "+typeof n)}Object.freeze(Main.prototype),Object.freeze(Main),window.blueprintUE.diff.Main=Main;
}());
